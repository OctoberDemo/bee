<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>腾讯房产蜜蜂</title>
    <script src="bee.js"></script>
</head>
<body>
<script>

    Bee.addChannel("房产", "上海", "http://sh.house.qq.com/l/shloushi/list_80.htm");
    Bee.setType("house.qq.com");
    Bee.setImgReferer("house.qq.com");
//    Bee.requestNoScript();
//    Bee.requestNoCss();
    Bee.onListLoaded = function (dom) {
        var items = [];
        var contList = dom.byClass("mod newslist");
        var lis = contList.byTags("li");
        for (var i = 0; i < lis.length; i++) {
            var item = {};
            var li = lis[i];
            var a = li.byTag("a", true);
            if (a == undefined) {
                continue;
            }
            item.url = a.href;
            item.title = a.innerText;
            items.push(item);
        }
        Bee.finishExtractList(items);
    };

    function loadItem(dom, item) {
        var article = dom.byId("Cnt-Main-Article-QQ", true);
        if (article == undefined) {
            console.log("article == undefined");
            Bee.finishExtractItem();
            return;
        }
        var attrib = dom.byClass("tit-bar clearfix", true);
        var sourceString = attrib.byClass("color-a-1").innerText;
        var timeString = attrib.byClass("article-time").innerText;
        item.created_at = Bee.convertTime(timeString);
        if (sourceString.indexOf("腾讯") < 0) {
            if (Bee.existSource(sourceString)) {
                console.log("跳过来源：" + sourceString);
                Bee.passItem(item);
                return;
            } else {
                console.log("未知来源：" + sourceString);
            }
        }
        item.source = sourceString;

        var des = article.byClass("titdd-Article", true);
        if (des && des.innerText.length > 0) {
            item.content = [];
            var desc = {};
            desc.desc = des.innerText.replace("[摘要]", "");
            item.content.add(desc);
        }

//        article.removeClass("titdd-Article");
//        article.removeTag("table");

        var hasRec = false;
        var articleNew = document.createElement("new-article");
        var articles = article.byTags("p");
        for (var i=0; i < articles.length; i++) {
            var p = articles[i];
            console.log(p);
//            if (p.innerText && p.innerText.indexOf("》》特别推荐：") >= 0 ) {
//                console.log("has");
//                hasRec = true;
//            }
//            if (p.byTag("a") && p.byTag("a").title.indexOf("返回腾讯")>=0) {
//                hasRec = true;
//                console.log("has");
//                break;
//            }
//            articleNew.appendChild(p);

//            if (hasRec) {
//                console.log(p);
//                article.removeChild(p);
//            }
        }
//        console.log(articleNew);
//        var content = Bee.htmlToJson(articleNew);
        if (item.content == undefined) {
            item.content = content;
        } else {
//            item.content = item.content.concat(content);
        }
        item.class = "";
        item.status = 5;
//        Bee.finishExtractItem(item, true, true);
    }

    Bee.onItemDomLoaded = function (dom, item) {

        var pageAll = dom.byClass("page-Article-QQ", true);
        if (pageAll) {
            pageAll.click();
            setTimeout(function() {
                loadItem(dom, item);
            }, 1000);
            return;
        }
        setTimeout(function() {
            loadItem(dom, item);
        }, 500);
    };

//    Bee.start();
    Bee.debug("http://sh.house.qq.com/a/20140613/009582.htm");
</script>
</body>
</html>